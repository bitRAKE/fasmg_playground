
; Listing generator, which shows generated bytes next to offset in the output file
; and assumed address in memory (limited to the constant term if an address is a linear polynomial).
; The listing is stored in a file with .LST extension.

include 'xcalm.inc'

define Listing? Listing

namespace Listing

	virtual at 0
		HexDigits:: db '0123456789ABCDEF'
	end virtual

	collected_source = ''
	collected_$ = $
	collected_$% = $%
	collected_$%% = $%%

	calminstruction generate
		local	source, $, $%, $%%

	    reverse:
		take	source, collected_source
		take	$, collected_$
		take	$%, collected_$%
		take	$%%, collected_$%%
		jyes	reverse

		local	offset
		compute offset, $%

	    main:
		take	, $%
		take	, $%%
		take	$%, $%
		jno	done

		check	source
		jno	next

		local	undefined_bytes, defined_bytes
		compute undefined_bytes, $% - $%%
		compute defined_bytes, $%% - offset
		compute offset, $%

		local	counter, digit

		compute counter, 16
		asm	db '['
	    print_address:
		compute counter, counter - 1
		compute digit, ($ shr (counter shl 2)) and 0Fh
		asm	load digit:1 from HexDigits:digit
		asm	db digit
		check	counter
		jyes	print_address
		asm	db '] '

		check	defined_bytes > 0
		jyes	bytes_present
		asm	db 34 dup ' '
		jump	print_source

	    bytes_present:
		compute counter, 8
	    print_offset:
		compute counter, counter - 1
		compute digit, (($%-undefined_bytes-defined_bytes) shr (counter shl 2)) and 0Fh
		asm	load digit:1 from HexDigits:digit
		asm	db digit
		check	counter
		jyes	print_offset

		local	column, byte

		asm	db ': '
		compute column, 0
	    print_bytes:
		check	defined_bytes > 0
		jno	fill_up
		asm	load byte:1 from : $% - undefined_bytes - defined_bytes
		check	column = 8
		jno	print_byte
		compute column, 0
		asm	db ' ',source,13,10,29 dup ' '
		compute source, ''
	    print_byte:
		compute digit, byte shr 4
		asm	load digit:1 from HexDigits:digit
		asm	db digit
		compute digit, byte and 0Fh
		asm	load digit:1 from HexDigits:digit
		asm	db digit, ' '
		compute defined_bytes, defined_bytes - 1
		compute column, column + 1
		jump	print_bytes
	    fill_up:
		asm	db 8-column dup '   '
	    print_source:
		asm	db ' ',source,13,10
	    next:
		take	, source
		take	, $
		jump	main
	    done:
	end calminstruction

end namespace

postpone ?
	purge ?
	virtual as 'lst'
		Listing.generate
	end virtual
end postpone

calminstruction ? line&
	local	tmp
	arrange tmp, line
	stringify tmp
	take	Listing.collected_source, tmp
	compute tmp, $ scale 0
	take	Listing.collected_$, tmp
	compute tmp, $%
	take	Listing.collected_$%, tmp
	compute tmp, $%%
	take	Listing.collected_$%%, tmp
	assemble line
end calminstruction

calminstruction restartout? origin
	arrange origin, =restartout origin
	assemble origin
    reset:
	take	, Listing.collected_source
	take	, Listing.collected_$
	take	, Listing.collected_$%
	take	, Listing.collected_$%%
	jyes	reset
end calminstruction
